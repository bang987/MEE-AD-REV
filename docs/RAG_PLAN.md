# RAG 구현 계획: 의료광고 법규 기반 분석 고도화

## 개요
현재 GPT-4만 사용하는 방식의 한계를 극복하고, 정확한 법규 인용과 일관된 판정을 위해 RAG(Retrieval-Augmented Generation) 시스템을 구축한다.

## 현재 방식의 한계

| 문제 | 설명 |
|------|------|
| 할루시네이션 | GPT-4가 존재하지 않는 법규를 인용할 수 있음 |
| 최신성 부족 | 학습 컷오프 이후 개정된 법규 반영 안됨 |
| 일관성 문제 | 같은 광고에 대해 다른 판정 가능 |
| 근거 불명확 | 어떤 조항을 기반으로 판단했는지 불분명 |

## RAG 도입 효과

| 개선점 | 설명 |
|--------|------|
| 정확한 법규 인용 | 실제 문서에서 검색하여 인용 |
| 최신 법규 반영 | 문서만 업데이트하면 즉시 반영 |
| 판정 근거 명확 | 어떤 조항 기반인지 투명하게 제시 |
| 일관성 향상 | 동일 법규 기준으로 판정 |

---

## Phase 1: 법규 문서 수집

### 수집 대상 문서

| 문서명 | 출처 | 우선순위 | 형식 |
|--------|------|----------|------|
| 의료법 제56조 (의료광고의 금지 등) | 국가법령정보센터 | 높음 | HTML/PDF |
| 의료법 시행령 제23조 | 국가법령정보센터 | 높음 | HTML/PDF |
| 의료법 시행규칙 제41조~46조 | 국가법령정보센터 | 높음 | HTML/PDF |
| 의료광고심의에 관한 규정 | 대한의사협회 | 높음 | PDF |
| 의료광고 자율심의 기준 | 심의기관 | 중간 | PDF |
| 의료광고 심의기준 해설서 | 심의기관 | 중간 | PDF |
| 의료광고 위반 사례집 | 보건복지부 | 중간 | PDF |
| 식약처 의료기기 광고 가이드 | 식약처 | 낮음 | PDF |

### 문서 수집 방법
1. 국가법령정보센터 API 활용 (https://www.law.go.kr)
2. 대한의사협회 공개 자료 다운로드
3. 보건복지부 공개 자료 다운로드

---

## Phase 2: 기술 스택 선정

### 파이프라인 구조
```
문서 → 전처리 → 청킹 → 임베딩 → 벡터DB → 검색 → LLM
```

### 기술 스택 비교 및 선정

#### 문서 파서
| 옵션 | 장점 | 단점 | 선정 |
|------|------|------|------|
| PyPDF2 | 간단 | 레이아웃 손실 | |
| pdfplumber | 테이블 추출 가능 | 느림 | |
| Unstructured | 다양한 포맷 지원 | 의존성 많음 | O |

#### 청킹 프레임워크
| 옵션 | 장점 | 단점 | 선정 |
|------|------|------|------|
| LangChain | 생태계 풍부, 문서 많음 | 무거움 | O |
| LlamaIndex | RAG 특화 | 학습곡선 | |
| 직접 구현 | 가벼움 | 시간 소요 | |

#### 임베딩 모델
| 옵션 | 장점 | 단점 | 선정 |
|------|------|------|------|
| OpenAI text-embedding-3-small | 성능 좋음, 저렴 | API 의존 | O |
| OpenAI text-embedding-3-large | 최고 성능 | 비용 높음 | |
| Upstage Embedding | 한국어 특화 | 추가 API 필요 | |
| KoSimCSE | 무료, 로컬 | 성능 제한 | |

#### 벡터 데이터베이스
| 옵션 | 장점 | 단점 | 선정 |
|------|------|------|------|
| Chroma | 로컬, 무료, 간단 | 대규모 제한 | O |
| FAISS | 빠름, 무료 | 메타데이터 제한 | |
| Pinecone | 관리형, 확장성 | 유료 | |
| Weaviate | 하이브리드 검색 | 복잡 | |

### 최종 선정 스택
```
Unstructured + LangChain + OpenAI Embedding + Chroma + GPT-4
```

---

## Phase 3: 구현 단계

### 3.1 문서 수집 및 정제 (예상 1-2일)

```python
# 예시 구조
backend/
├── rag/
│   ├── __init__.py
│   ├── document_loader.py    # 문서 로딩
│   ├── preprocessor.py       # 전처리
│   ├── embedder.py           # 임베딩
│   ├── vector_store.py       # 벡터DB 관리
│   └── retriever.py          # 검색
├── data/
│   └── legal_documents/
│       ├── 의료법.pdf
│       ├── 의료법시행령.pdf
│       ├── 의료광고심의규정.pdf
│       └── ...
```

### 3.2 청킹 전략 설계 (예상 1일)

#### 청킹 전략
- **방식**: 조항 단위 청킹 (의미 단위 보존)
- **청크 크기**: 500-1000 토큰
- **오버랩**: 100 토큰 (문맥 유지)

#### 메타데이터 구조
```python
{
    "chunk_id": "medical_law_56_1",
    "source": "의료법",
    "article": "제56조",
    "paragraph": "1항",
    "title": "의료광고의 금지 등",
    "content": "의료법인·의료기관·의료인이 아닌 자는...",
    "keywords": ["의료광고", "금지", "허가"],
    "last_updated": "2024-01-15"
}
```

### 3.3 임베딩 & 벡터DB 구축 (예상 1일)

```python
# 예시 코드 (embedder.py)
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import Chroma

embeddings = OpenAIEmbeddings(model="text-embedding-3-small")
vectorstore = Chroma(
    collection_name="medical_ad_laws",
    embedding_function=embeddings,
    persist_directory="./chroma_db"
)
```

### 3.4 검색 파이프라인 구현 (예상 1-2일)

```python
# 예시 코드 (retriever.py)
def search_relevant_laws(query: str, top_k: int = 5) -> list:
    """광고 텍스트에서 관련 법규 조항 검색"""
    results = vectorstore.similarity_search(
        query=query,
        k=top_k,
        filter={"source": {"$in": ["의료법", "의료광고심의규정"]}}
    )
    return results
```

### 3.5 GPT-4 통합 (예상 1-2일)

```python
# 예시: 향상된 프롬프트
def build_enhanced_prompt(ad_text: str, relevant_laws: list) -> str:
    laws_context = "\n\n".join([
        f"[{law.metadata['source']} {law.metadata['article']}]\n{law.page_content}"
        for law in relevant_laws
    ])

    return f"""당신은 의료광고 심의 전문가입니다.

## 관련 법규 조항
{laws_context}

## 분석 대상 광고 텍스트
{ad_text}

## 요청사항
위 법규 조항을 근거로 광고의 위반 여부를 판정하고,
각 판정에 대해 정확한 법규 조항을 인용해주세요.
"""
```

---

## Phase 4: 시스템 아키텍처

```
┌─────────────────────────────────────────────────────┐
│                    광고 이미지                        │
└────────────────────────┬────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────┐
│                 OCR (Naver/Paddle)                   │
└────────────────────────┬────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────┐
│              키워드 기반 1차 분석                      │
│           (기존 medical_keywords.py)                 │
└────────────────────────┬────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────┐
│            RAG: 관련 법규 조항 검색 (NEW)             │
│  ┌─────────────┐    ┌─────────────────────────────┐ │
│  │ 광고 텍스트  │───▶│  Chroma 벡터DB 검색         │ │
│  │ + 위반키워드 │    │  (의료법, 심의기준 등)       │ │
│  └─────────────┘    └──────────────┬──────────────┘ │
│                                    │                │
│                     ┌──────────────▼──────────────┐ │
│                     │  관련 법규 조항 (top-5)      │ │
│                     │  - 의료법 제56조 1항        │ │
│                     │  - 심의규정 제12조          │ │
│                     │  - ...                      │ │
│                     └──────────────┬──────────────┘ │
└────────────────────────────────────┼────────────────┘
                                     ▼
┌─────────────────────────────────────────────────────┐
│              GPT-4 분석 (Enhanced)                   │
│  ┌─────────────────────────────────────────────────┐│
│  │ 입력:                                           ││
│  │ - 광고 텍스트                                   ││
│  │ - 1차 분석 결과 (위반 키워드)                   ││
│  │ - 검색된 관련 법규 조항 (top-5)                 ││
│  │                                                 ││
│  │ 출력:                                           ││
│  │ - 위반 여부 판정                                ││
│  │ - 정확한 법규 조항 인용                         ││
│  │ - 판정 근거 설명                                ││
│  └─────────────────────────────────────────────────┘│
└────────────────────────────────────┬────────────────┘
                                     ▼
┌─────────────────────────────────────────────────────┐
│                   최종 판정 결과                      │
│  ┌─────────────────────────────────────────────────┐│
│  │ 판정: 부적합 (반려)                              ││
│  │                                                 ││
│  │ 위반사항:                                       ││
│  │ 1. "100% 완치" → 의료법 제56조 제2항 제1호 위반 ││
│  │    (치료효과 보장 광고 금지)                    ││
│  │ 2. "최고의 의료진" → 심의규정 제15조 위반       ││
│  │    (비교/우위 광고 금지)                        ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
```

---

## Phase 5: 비용 분석

### 초기 구축 비용

| 항목 | 예상 비용 |
|------|-----------|
| Chroma (로컬) | 무료 |
| 문서 임베딩 (1회) | ~$0.50 (약 500페이지 기준) |
| 개발 시간 | 5-8일 |

### 운영 비용 (월간)

| 항목 | 예상 비용 |
|------|-----------|
| 검색 임베딩 (쿼리당) | ~$0.0001 |
| GPT-4 (기존과 동일) | 기존 비용 유지 |
| 월 1000건 분석 시 추가 비용 | ~$0.10 |

### 총 추가 비용
**거의 없음** (기존 GPT-4 비용 대비 무시 가능)

---

## Phase 6: 평가 지표

### 정량적 지표
| 지표 | 목표 |
|------|------|
| 법규 인용 정확도 | > 95% |
| 판정 일관성 | > 90% (동일 광고 재분석 시) |
| 검색 관련성 (top-5 내 정답) | > 85% |
| 응답 시간 증가 | < 1초 |

### 정성적 지표
- 전문가 리뷰 (변호사/의료광고 심의위원)
- 사용자 피드백

---

## 다음 단계 (TODO)

- [ ] 법규 문서 수집 시작
- [ ] LangChain + Chroma 환경 설정
- [ ] 파일럿 테스트 (의료법 56조만으로)
- [ ] 전체 문서 확장
- [ ] 기존 시스템 통합
- [ ] 성능 평가

---

## 참고 자료

- [LangChain RAG 가이드](https://python.langchain.com/docs/tutorials/rag/)
- [Chroma 공식 문서](https://docs.trychroma.com/)
- [OpenAI Embedding 모델](https://platform.openai.com/docs/guides/embeddings)
- [국가법령정보센터](https://www.law.go.kr)
