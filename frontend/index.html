<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>의료광고 AI 심의 시스템</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .header-content { max-width: 1200px; margin: 0 auto; }
        .header-title { font-size: 1.8rem; color: #2d3748; margin-bottom: 0.3rem; }
        .header-subtitle { font-size: 0.95rem; color: #718096; }
        .main-content { flex: 1; max-width: 1200px; width: 100%; margin: 1.5rem auto; padding: 0 1rem; }

        .upload-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .upload-header { margin-bottom: 1rem; }
        .upload-header h2 { font-size: 1.3rem; color: #2d3748; }

        .file-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
        }
        .file-label:hover { border-color: #667eea; background: #edf2f7; }
        .file-text { font-size: 1rem; color: #2d3748; margin-bottom: 0.3rem; font-weight: 500; }
        .file-hint { font-size: 0.85rem; color: #718096; }
        .file-input { display: none; }

        .selected-files-list {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f7fafc;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        .selected-files-list.show { display: block; }
        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0.5rem;
            margin: 0.2rem 0;
            background: white;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .file-item-size { color: #718096; }

        .ai-option {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f7fafc;
            border-radius: 8px;
        }
        .ai-option .option-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .ai-option .option-row:last-child { margin-bottom: 0; }
        .ai-option .option-label { font-size: 0.9rem; color: #4a5568; font-weight: 600; min-width: 70px; }
        .ai-option .radio-label, .ai-option .checkbox-label { display: flex; align-items: center; gap: 0.4rem; cursor: pointer; }
        .ai-option input[type="checkbox"], .ai-option input[type="radio"] { width: 16px; height: 16px; accent-color: #667eea; }
        .ai-option span { font-size: 0.9rem; color: #2d3748; }

        .button-group { display: flex; gap: 0.75rem; margin-top: 1rem; }
        .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: #e2e8f0; color: #2d3748; }

        .progress-section { margin-top: 1rem; padding: 1rem; background: #f7fafc; border-radius: 8px; }
        .progress-section h3 { margin-bottom: 0.75rem; color: #2d3748; font-size: 1rem; }
        .progress-bar-container { width: 100%; height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        #progress-text { text-align: center; color: #4a5568; font-size: 0.9rem; margin-top: 0.5rem; }

        .batch-result-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .batch-result-section h2 { margin-bottom: 1rem; color: #2d3748; font-size: 1.3rem; }

        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem; }
        .filter-group { display: flex; gap: 0.4rem; }
        .filter-btn {
            padding: 0.4rem 0.8rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .filter-btn:hover { border-color: #667eea; }
        .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .sort-group { display: flex; align-items: center; gap: 0.4rem; }
        .sort-group label { font-size: 0.85rem; color: #4a5568; }
        .sort-group select { padding: 0.4rem 0.6rem; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; }

        .table-wrapper { overflow-x: auto; }
        #results-table { width: 100%; border-collapse: collapse; }
        #results-table th { background: #f7fafc; padding: 0.75rem; text-align: left; font-size: 0.85rem; border-bottom: 2px solid #e2e8f0; }
        #results-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; }
        #results-table tr:hover { background: #f7fafc; }

        .table-judgment { padding: 0.3rem 0.6rem; border-radius: 4px; font-weight: 600; font-size: 0.8rem; }
        .table-judgment.passed { background: #c6f6d5; color: #22543d; }
        .table-judgment.rejected { background: #fed7d7; color: #742a2a; }
        .table-judgment.review { background: #feebc8; color: #7c2d12; }

        .table-risk-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        .table-risk-badge.risk-safe { background: #c6f6d5; color: #22543d; }
        .table-risk-badge.risk-low { background: #bee3f8; color: #2c5282; }
        .table-risk-badge.risk-medium { background: #feebc8; color: #7c2d12; }
        .table-risk-badge.risk-high { background: #fed7d7; color: #742a2a; }
        .table-risk-badge.risk-critical { background: #feb2b2; color: #742a2a; }

        .view-detail-btn { padding: 0.3rem 0.6rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .view-detail-btn:hover { background: #5568d3; }

        .result-section { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: none; margin-bottom: 1.5rem; }
        .result-section.show { display: block; }
        .result-section h2 { font-size: 1.3rem; color: #2d3748; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e2e8f0; }

        .result-card { background: #f7fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .result-card h3 { font-size: 1.1rem; color: #2d3748; margin-bottom: 0.75rem; }

        .judgment-card { background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border: 2px solid #e2e8f0; }
        .judgment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e2e8f0; }
        .judgment-badge { padding: 0.4rem 1rem; border-radius: 20px; font-size: 1rem; font-weight: 700; }
        .judgment-badge.passed { background: #48bb78; color: white; }
        .judgment-badge.rejected { background: #e53e3e; color: white; }
        .judgment-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .judgment-item { display: flex; flex-direction: column; align-items: center; gap: 0.3rem; padding: 0.75rem; background: white; border-radius: 8px; }
        .judgment-label { font-size: 0.8rem; color: #718096; }
        .judgment-value { font-size: 1.2rem; font-weight: 700; color: #2d3748; }
        .judgment-summary { padding: 0.75rem; background: white; border-radius: 8px; border-left: 4px solid #667eea; }
        .judgment-summary p { color: #4a5568; line-height: 1.5; font-size: 0.9rem; }

        .risk-safe { color: #38a169; }
        .risk-low { color: #48bb78; }
        .risk-medium { color: #ed8936; }
        .risk-high { color: #e53e3e; }
        .risk-critical { color: #c53030; }

        .ocr-text-highlighted { color: #2d3748; line-height: 1.6; padding: 0.75rem; background: white; border-radius: 6px; white-space: pre-wrap; font-size: 0.9rem; }
        .highlight-high { background: #fed7d7; color: #c53030; padding: 1px 3px; border-radius: 3px; font-weight: 600; }
        .highlight-medium { background: #feebc8; color: #c05621; padding: 1px 3px; border-radius: 3px; font-weight: 600; }
        .highlight-low { background: #fefcbf; color: #744210; padding: 1px 3px; border-radius: 3px; font-weight: 600; }
        .ocr-confidence { font-size: 0.8rem; color: #718096; margin-top: 0.5rem; }

        .violations-detail-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .violation-detail-card { background: white; border-radius: 8px; border-left: 4px solid #cbd5e0; overflow: hidden; }
        .violation-detail-header { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f7fafc; border-bottom: 1px solid #e2e8f0; }
        .violation-severity-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .violation-severity-badge.high { background: #fed7d7; color: #c53030; }
        .violation-severity-badge.medium { background: #feebc8; color: #c05621; }
        .violation-severity-badge.low { background: #fefcbf; color: #744210; }
        .violation-keyword-main { font-size: 1rem; font-weight: 700; color: #2d3748; flex: 1; }
        .violation-score-badge { padding: 0.25rem 0.5rem; background: #edf2f7; color: #2d3748; border-radius: 15px; font-size: 0.8rem; font-weight: 700; }
        .violation-detail-body { padding: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .violation-info-row { display: flex; align-items: flex-start; gap: 0.5rem; font-size: 0.85rem; }
        .info-label { font-weight: 600; color: #4a5568; min-width: 70px; }
        .info-value { color: #2d3748; flex: 1; }
        .law-text { color: #667eea; font-weight: 500; }
        .bonus-indicator { color: #e53e3e; font-weight: 600; font-size: 0.8rem; }

        .ai-analysis-card { background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%); border: 2px solid #667eea; }
        .ai-analysis-text { margin: 0; padding: 0.75rem; background: white; border-radius: 6px; color: #2d3748; line-height: 1.6; white-space: pre-wrap; font-size: 0.85rem; border-left: 4px solid #667eea; }

        .footer { background: rgba(255, 255, 255, 0.95); padding: 1rem; text-align: center; color: #718096; font-size: 0.85rem; }

        @media (max-width: 768px) {
            .header-title { font-size: 1.4rem; }
            .table-controls { flex-direction: column; align-items: flex-start; }
            .judgment-content { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-content">
                <h1 class="header-title">의료광고 AI 심의 시스템</h1>
                <p class="header-subtitle">의료광고 이미지의 법규 준수 여부를 AI로 분석합니다</p>
            </div>
        </header>

        <main class="main-content">
            <!-- 배치 업로드 섹션 -->
            <div class="upload-card">
                <div class="upload-header">
                    <h2>광고 이미지 배치 분석</h2>
                </div>

                <div class="file-input-area">
                    <label for="batch-file-input" class="file-label">
                        <span class="file-text">이미지 파일을 선택하세요 (최대 50개)</span>
                        <span class="file-hint">JPG, PNG (파일당 최대 10MB)</span>
                    </label>
                    <input id="batch-file-input" type="file" accept="image/jpeg,image/jpg,image/png" class="file-input" multiple />
                </div>

                <div id="selected-files-list" class="selected-files-list"></div>

                <div id="batch-options" class="ai-option" style="display: none;">
                    <div class="option-row">
                        <span class="option-label">OCR 엔진:</span>
                        <label class="radio-label"><input type="radio" name="ocr-engine" value="naver" checked><span>Naver OCR (클라우드, 정확도 99%)</span></label>
                        <label class="radio-label"><input type="radio" name="ocr-engine" value="paddle"><span>PaddleOCR (로컬, 무료)</span></label>
                    </div>
                    <div class="option-row">
                        <label class="checkbox-label">
                            <input type="checkbox" id="batch-use-ai">
                            <span>GPT-4 AI 분석 사용 (법규 근거 포함, +15초/파일)</span>
                        </label>
                    </div>
                </div>

                <div class="button-group">
                    <button id="batch-analyze-btn" class="btn btn-primary" disabled>분석 시작</button>
                    <button id="batch-reset-btn" class="btn btn-secondary" style="display: none;">초기화</button>
                </div>

                <div id="progress-section" class="progress-section" style="display: none;">
                    <h3>분석 진행 중...</h3>
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <p id="progress-text">0/0 (0%)</p>
                </div>
            </div>

            <!-- 배치 결과 테이블 -->
            <div id="batch-result-section" class="batch-result-section" style="display: none;">
                <h2>분석 결과</h2>
                <div class="table-controls">
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all">전체</button>
                        <button class="filter-btn" data-filter="approved">통과</button>
                        <button class="filter-btn" data-filter="rejected">반려</button>
                        <button class="filter-btn" data-filter="review">검토</button>
                    </div>
                    <div class="sort-group">
                        <label>정렬:</label>
                        <select id="sort-select">
                            <option value="filename">파일명</option>
                            <option value="score">점수</option>
                            <option value="risk">위험도</option>
                        </select>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>파일명</th>
                                <th>판정</th>
                                <th>총점</th>
                                <th>위험도</th>
                                <th>위반</th>
                                <th>상세</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body"></tbody>
                    </table>
                </div>
                <div class="button-group">
                    <button id="classify-btn" class="btn btn-primary">전체 승인 및 분류</button>
                </div>
            </div>

            <!-- 상세 결과 섹션 -->
            <div id="result-section" class="result-section">
                <h2>상세 분석 결과</h2>
                <div id="result-content"></div>
            </div>
        </main>

        <footer class="footer">
            <p>의료광고 AI 심의 시스템 MVP v1.0</p>
        </footer>
    </div>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '192.168.0.2'
            ? 'http://192.168.0.2:8000'
            : `http://${window.location.hostname}:8000`;

        let selectedBatchFiles = [];
        let currentBatchId = null;
        let pollingInterval = null;
        let batchResults = [];
        let filteredResults = [];
        let currentFilter = 'all';
        let currentSort = 'filename';

        const batchFileInput = document.getElementById('batch-file-input');
        const selectedFilesList = document.getElementById('selected-files-list');
        const batchOptions = document.getElementById('batch-options');
        const batchUseAI = document.getElementById('batch-use-ai');
        const batchAnalyzeBtn = document.getElementById('batch-analyze-btn');
        const batchResetBtn = document.getElementById('batch-reset-btn');
        const progressSection = document.getElementById('progress-section');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const batchResultSection = document.getElementById('batch-result-section');
        const resultsTableBody = document.getElementById('results-table-body');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const sortSelect = document.getElementById('sort-select');
        const classifyBtn = document.getElementById('classify-btn');
        const resultSection = document.getElementById('result-section');
        const resultContent = document.getElementById('result-content');

        // 파일 선택
        batchFileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            if (files.length > 50) { alert('최대 50개 파일만 선택 가능합니다.'); return; }

            for (const file of files) {
                if (!file.type.startsWith('image/')) { alert(`이미지만 가능: ${file.name}`); return; }
                if (file.size > 10 * 1024 * 1024) { alert(`10MB 초과: ${file.name}`); return; }
            }

            selectedBatchFiles = files;
            selectedFilesList.innerHTML = files.map(f =>
                `<div class="file-item"><span>${f.name}</span><span class="file-item-size">${(f.size/1024).toFixed(1)}KB</span></div>`
            ).join('');
            selectedFilesList.classList.add('show');
            batchOptions.style.display = 'block';
            batchAnalyzeBtn.disabled = false;
            batchResetBtn.style.display = 'inline-block';
        });

        // 프로그레스바 업데이트 함수
        function updateProgress(percent, statusText) {
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent}%`;
            progressText.textContent = statusText;
        }

        // 분석 시작
        batchAnalyzeBtn.addEventListener('click', async () => {
            if (selectedBatchFiles.length === 0) return;

            batchAnalyzeBtn.disabled = true;
            batchAnalyzeBtn.textContent = '업로드 중...';
            progressSection.style.display = 'block';
            batchResultSection.style.display = 'none';
            resultSection.classList.remove('show');

            // 업로드 시작: 0%
            updateProgress(0, '파일 업로드 중...');

            try {
                const formData = new FormData();
                selectedBatchFiles.forEach(file => formData.append('files', file));
                formData.append('use_ai', batchUseAI.checked ? 'true' : 'false');
                const selectedOcrEngine = document.querySelector('input[name="ocr-engine"]:checked').value;
                formData.append('ocr_engine', selectedOcrEngine);

                const response = await fetch(`${API_BASE_URL}/api/batch-upload-analyze`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('배치 분석 시작 실패');

                const data = await response.json();
                currentBatchId = data.batch_id;

                // 업로드 완료: 30%
                updateProgress(30, '업로드 완료! 분석 시작 중...');
                batchAnalyzeBtn.textContent = '분석 중...';

                startPolling(currentBatchId);
            } catch (error) {
                alert(`오류: ${error.message}`);
                resetUI();
            }
        });

        function startPolling(batchId) {
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/batch-status/${batchId}`);
                    if (!response.ok) throw new Error('상태 조회 실패');

                    const status = await response.json();

                    // 서버 진행률(0-100%)을 30-70% 범위로 매핑
                    // 업로드 완료: 30%, 분석 진행: 30-70%, 분석 완료: 100%
                    const serverPercent = status.progress_percent;
                    let displayPercent;
                    let statusText;

                    if (status.status === 'completed') {
                        displayPercent = 100;
                        statusText = `분석 완료! ${status.processed_files}/${status.total_files}`;
                    } else if (status.status === 'processing') {
                        // 30% + (서버진행률 * 0.4) = 30% ~ 70% 범위
                        displayPercent = Math.round(30 + (serverPercent * 0.4));
                        statusText = `분석 진행 중... ${status.processed_files}/${status.total_files}`;
                    } else {
                        displayPercent = 30;
                        statusText = `대기 중... ${status.processed_files}/${status.total_files}`;
                    }

                    updateProgress(displayPercent, statusText);

                    if (status.status === 'completed') {
                        clearInterval(pollingInterval);
                        batchResults = status.results;
                        showBatchResults();
                        resetUI();
                    } else if (status.status === 'failed') {
                        clearInterval(pollingInterval);
                        alert('분석 실패: ' + status.errors.join(', '));
                        resetUI();
                    }
                } catch (error) {
                    console.error('폴링 오류:', error);
                }
            }, 2000);
        }

        function resetUI() {
            batchAnalyzeBtn.disabled = false;
            batchAnalyzeBtn.textContent = '분석 시작';
            progressSection.style.display = 'none';
        }

        function showBatchResults() {
            batchResultSection.style.display = 'block';
            renderResultsTable();
        }

        function renderResultsTable() {
            filteredResults = batchResults.filter(r => {
                if (!r.success || !r.analysis_result) return false;
                if (currentFilter === 'all') return true;
                return getCategory(r.analysis_result.risk_level) === currentFilter;
            });

            filteredResults.sort((a, b) => {
                if (currentSort === 'filename') return a.filename.localeCompare(b.filename);
                if (currentSort === 'score') return (b.analysis_result?.total_score || 0) - (a.analysis_result?.total_score || 0);
                if (currentSort === 'risk') {
                    const order = { 'CRITICAL': 5, 'HIGH': 4, 'MEDIUM': 3, 'LOW': 2, 'SAFE': 1 };
                    return (order[b.analysis_result?.risk_level] || 0) - (order[a.analysis_result?.risk_level] || 0);
                }
                return 0;
            });

            resultsTableBody.innerHTML = filteredResults.length === 0
                ? '<tr><td colspan="6" style="text-align:center;padding:2rem;">결과 없음</td></tr>'
                : filteredResults.map((r, i) => {
                    const a = r.analysis_result;
                    const j = getJudgment(a.risk_level);
                    return `<tr>
                        <td>${r.filename}</td>
                        <td><span class="table-judgment ${j.cls}">${j.text}</span></td>
                        <td>${a.total_score}점</td>
                        <td><span class="table-risk-badge risk-${a.risk_level.toLowerCase()}">${a.risk_level}</span></td>
                        <td>${a.violation_count}건</td>
                        <td><button class="view-detail-btn" onclick="viewDetail(${i})">상세</button></td>
                    </tr>`;
                }).join('');
        }

        function getJudgment(level) {
            const cat = getCategory(level);
            if (cat === 'approved') return { text: '통과', cls: 'passed' };
            if (cat === 'rejected') return { text: '반려', cls: 'rejected' };
            return { text: '검토', cls: 'review' };
        }

        function getCategory(level) {
            level = level.toUpperCase();
            if (level === 'SAFE' || level === 'LOW') return 'approved';
            if (level === 'HIGH' || level === 'CRITICAL') return 'rejected';
            return 'review';
        }

        window.viewDetail = function(index) {
            const r = filteredResults[index];
            if (!r || !r.success) return;

            const { ocr_result, analysis_result } = r;
            const j = getJudgment(analysis_result.risk_level);

            let html = `
                <div class="result-card judgment-card">
                    <div class="judgment-header">
                        <h3>${r.filename}</h3>
                        <span class="judgment-badge ${j.cls}">${j.text}</span>
                    </div>
                    <div class="judgment-content">
                        <div class="judgment-item"><span class="judgment-label">총점</span><span class="judgment-value risk-${analysis_result.risk_level.toLowerCase()}">${analysis_result.total_score}점</span></div>
                        <div class="judgment-item"><span class="judgment-label">위험도</span><span class="judgment-value">${analysis_result.risk_level}</span></div>
                        <div class="judgment-item"><span class="judgment-label">위반</span><span class="judgment-value">${analysis_result.violation_count}건</span></div>
                    </div>
                    <div class="judgment-summary"><p>${analysis_result.summary}</p></div>
                </div>
                <div class="result-card">
                    <h3>추출된 텍스트</h3>
                    <div class="ocr-text-highlighted">${highlightKeywords(ocr_result.text, analysis_result.violations)}</div>
                    <p class="ocr-confidence">OCR 신뢰도: ${(ocr_result.confidence * 100).toFixed(1)}%</p>
                </div>`;

            if (analysis_result.violations?.length > 0) {
                html += `<div class="result-card"><h3>위반 사항 (${analysis_result.violation_count}건)</h3><div class="violations-detail-list">`;
                analysis_result.violations.forEach(v => {
                    html += `<div class="violation-detail-card">
                        <div class="violation-detail-header">
                            <span class="violation-severity-badge ${v.severity.toLowerCase()}">${v.severity}</span>
                            <span class="violation-keyword-main">${v.keyword}</span>
                            <span class="violation-score-badge">${v.total_score}점</span>
                        </div>
                        <div class="violation-detail-body">
                            <div class="violation-info-row"><span class="info-label">분류:</span><span class="info-value">${v.category}</span></div>
                            <div class="violation-info-row"><span class="info-label">검출:</span><span class="info-value">${v.count}회${v.repetition_bonus > 0 ? ` <span class="bonus-indicator">(+${v.repetition_bonus}점)</span>` : ''}</span></div>
                            <div class="violation-info-row"><span class="info-label">법규:</span><span class="info-value law-text">${v.law}</span></div>
                        </div>
                    </div>`;
                });
                html += '</div></div>';
            }

            if (analysis_result.ai_analysis) {
                html += `<div class="result-card ai-analysis-card"><h3>AI 분석 (GPT-4)</h3><pre class="ai-analysis-text">${analysis_result.ai_analysis}</pre></div>`;
            }

            resultContent.innerHTML = html;
            resultSection.classList.add('show');
            resultSection.scrollIntoView({ behavior: 'smooth' });
        };

        function highlightKeywords(text, violations) {
            if (!text || !violations?.length) return text || '';
            const map = {};
            violations.forEach(v => { if (v.keyword) map[v.keyword.toLowerCase()] = v.severity.toLowerCase(); });
            const keywords = Object.keys(map).sort((a, b) => b.length - a.length);
            if (!keywords.length) return text;
            const escape = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${keywords.map(escape).join('|')})`, 'gi');
            return text.replace(regex, m => `<span class="highlight-${map[m.toLowerCase()]}">${m}</span>`);
        }

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderResultsTable();
            });
        });

        sortSelect.addEventListener('change', (e) => { currentSort = e.target.value; renderResultsTable(); });

        classifyBtn.addEventListener('click', async () => {
            if (!currentBatchId || !batchResults.length) return;
            if (!confirm('분석 결과에 따라 파일을 분류하시겠습니까?')) return;

            classifyBtn.disabled = true;
            classifyBtn.textContent = '분류 중...';

            try {
                const classifications = batchResults.filter(r => r.success && r.analysis_result)
                    .map(r => ({ filename: r.filename, category: getCategory(r.analysis_result.risk_level) }));

                const response = await fetch(`${API_BASE_URL}/api/classify-files`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ batch_id: currentBatchId, classifications })
                });

                if (!response.ok) throw new Error('분류 실패');
                const result = await response.json();
                alert(`분류 완료! 성공: ${result.success_count}, 실패: ${result.failed_count}`);
            } catch (error) {
                alert(`오류: ${error.message}`);
            } finally {
                classifyBtn.disabled = false;
                classifyBtn.textContent = '전체 승인 및 분류';
            }
        });

        batchResetBtn.addEventListener('click', () => {
            selectedBatchFiles = [];
            currentBatchId = null;
            batchResults = [];
            filteredResults = [];
            batchFileInput.value = '';
            selectedFilesList.innerHTML = '';
            selectedFilesList.classList.remove('show');
            batchOptions.style.display = 'none';
            batchAnalyzeBtn.disabled = true;
            batchResetBtn.style.display = 'none';
            progressSection.style.display = 'none';
            batchResultSection.style.display = 'none';
            resultSection.classList.remove('show');
            batchUseAI.checked = false;
            document.querySelector('input[name="ocr-engine"][value="naver"]').checked = true;
            if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
        });
    </script>
</body>
</html>
